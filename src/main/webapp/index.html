<html>
    <head>
        <title>lab 11</title>        
    </head>
    <body>
        <h4>Task1. Headers with ajax
            <br>
            <div>
                <input type="text" title="" id="x" value="3">
                <input type="text" title="" id="y" value="4"> <br>
                <input type="text" title="" id="z" readonly="readonly">
                <input type="button" value="sum" onclick="sum(true)">
            </div>
        </h4>    
        
        <h4>Task2,3. XML/JSON with ajax
            <br>
            <form action="#" method="post">
                <input name="n" id="n" type="text" placeholder="random value (int)" value="15">
                <div id="result-task-2-1"></div>
                <div id="result-task-2-2"></div>

                <input type="button" value="xml" onclick="getXML(this.form.n.value, true)">
                <input type="button" value="json" onclick="getJSON(this.form.n.value, true)">
            </form>
        </h4>

        <h4>Task4. async processing
            <div>
                <input type="button" value="sync" onclick="getSync()">
                <input type="button" value="async" onclick="getAsync()">
            </div>
        </h4>
        <script>
             function getAsync() {
                sum(true);
                getXML(document.getElementById("n").value, true);
                getJSON(document.getElementById("n").value, true);
            }

            function getSync() {
                sum(false);
                getXML(document.getElementById("n").value, false);
                getJSON(document.getElementById("n").value, false);
            }

            function sum(async) {
                console.log(async);

                const xhr = new XMLHttpRequest();
                xhr.open("GET", "http://localhost:8080/lab11/SssHeader", async);
                xhr.setRequestHeader("Value-x", document.getElementById("x").value);
                xhr.setRequestHeader("Value-y", document.getElementById("y").value);
                xhr.send();

                if (async) {
                    xhr.onreadystatechange = () => {
                        if (xhr.readyState === 4 && xhr.status === 200) {
                            document.getElementById("z").value = xhr.getResponseHeader("Value-z");
                        }
                    };
                } else {
                    document.getElementById("z").value = xhr.getResponseHeader("Value-z");
                }
            }

            function getJSON(n, async) {
                console.log(async);

                const xhr = new XMLHttpRequest();
                xhr.open("GET", "http://localhost:8080/lab11/SssJson", async);
                xhr.setRequestHeader("XRand-N", n);
                xhr.send();

                if (async) {
                    xhr.onreadystatechange = () => {
                        if (xhr.readyState === 4 && xhr.status === 200) {
                            document.getElementById("result-task-2-2").innerHTML = stringifyJSON(xhr);
                        }
                    };
                } else {
                    document.getElementById("result-task-2-2").innerHTML = stringifyJSON(xhr);
                }
            }

            function getXML(n, async) {
                console.log(async);

                const xhr = new XMLHttpRequest();
                xhr.open("GET", "http://localhost:8080/lab11/SssXml", async);
                xhr.setRequestHeader("XRand-N", n);
                xhr.send();

                if (async) {
                    xhr.onreadystatechange = () => {
                        if (xhr.readyState === 4 && xhr.status === 200) {
                            document.getElementById("result-task-2-1").innerHTML = stringifyXML(xhr);
                        }
                    };
                } else {
                    document.getElementById("result-task-2-1").innerHTML = stringifyXML(xhr);
                }
            }

            function stringifyXML(req){
                const xmlDoc = req.responseXML;
                const arr = Array.from(xmlDoc.getElementsByTagName("num"));
                return arr.map(number => number.innerHTML).join(" ");
            }

            function stringifyJSON(req){
                const arr = JSON.parse(req.responseText);
                return arr.join(" ");
            }
        </script>
    </body>
</html>